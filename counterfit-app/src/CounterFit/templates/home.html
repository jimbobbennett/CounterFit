<!DOCTYPE html>
<html>

<head>
    <title>CounterFit</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>

    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io();
        socket.on('connect', function () {
            socket.emit('my event', { data: 'I\'m connected!' });
        });
        socket.onmessage = (data) => {
            console.log(data);
        };
    </script>
</head>

<body class="bg-light" style="background-color: grey!important;">
    <header class="bd-header bg-dark py-3 d-flex align-items-stretch border-bottom border-dark fixed-top">
        <div class="container-fluid d-flex align-items-center">
            <h1 class="d-flex align-items-center fs-4 text-white mb-0">
                <img src="{{ url_for('static', filename='images/CounterFitLogo.png') }}" width="58" height="58"
                    class="me-3" alt="CounterFit logo">
                CounterFit - Virtual IoT Hardware
            </h1>

            <a class="btn btn-secondary ms-auto" href="https://github.com/jimbobbennett/CounterFit" target="_blank" hreflang="ar">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github"
                    viewBox="0 0 16 16">
                    <path
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z">
                    </path>
                </svg>
                Source
            </a>
        </div>
    </header>

    <div class="card shadow-sm border-dark" style="margin-left: 10px;margin-right: 10px; margin-bottom: 10px; margin-top: 100px;">
        <div class="card-header py-3">
            <h2 style="text-align:center">Sensors</h2>
        </div>
        <div class="card-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-3">
                        <div class="card shadow-sm border-primary" style="margin-top: 11px;">
                            <div class="card-header py-3 text-white bg-primary">
                                <h4 class="my-0 fw-normal" style="text-align:center">Create sensor</h4>
                            </div>
                            <div class="card-body">
                                <div class="container">
                                    <div class="row">
                                      <div class="col">
                                        Sensor Type:
                                      </div>
                                      <div class="col">
                                        <select name="new_sensor_type" id="new_sensor_type" class="form-control">
                                            {% for sensor_type in all_sensors %}
                                            <option value="{{ sensor_type.sensor_name() }}">{{ sensor_type.sensor_name() }}</option>
                                            {% endfor %}
                                        </select>
                                      </div>
                                    </div>
                                    <div class="row" style="margin-top: 20px;">
                                      <div class="col">
                                        Units:
                                      </div>
                                      <div class="col">
                                        <select name="new_sensor_units" id="new_sensor_units" class="form-control">
                                        </select>
                                      </div>
                                    </div>
                                    <div class="row" style="margin-top: 20px;">
                                      <div class="col">
                                        Pin:
                                      </div>
                                      <div class="col">
                                        <select name="new_sensor_pin" id="new_sensor_pin" class="form-control">
                                            {% for pin in pins %}
                                            <option value="{{ pin }}">{{ pin }}</option>
                                            {% endfor %}
                                        </select>
                                      </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="button" id="add_new_sensor_button" class="w-100 btn btn-lg btn-primary">Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-9">
                        <div class="container">
                            <div class="row row-cols-1 row-cols-sm-2 row-cols-sm-3 g-3">
                                
                                {% for sensor in sensors %}
            
                                    <div class="col">
                                        {% if sensor.sensor_type().name == "FLOAT": %}
                                            {% with sensor=sensor %}
                                                {% include "float_sensor.html" %}
                                            {% endwith %}
                                        {% endif %}
                                        {% if sensor.sensor_type().name == "BOOLEAN": %}
                                            {% with sensor=sensor %}
                                                {% include "boolean_sensor.html" %}
                                            {% endwith %}
                                        {% endif %}
                                    </div>
            
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-dark" style="margin: 10px;">
        <div class="card-header py-3">
            <h2 style="text-align:center">Actuators</h2>
        </div>
        <div class="card-body">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-3">
                        <div class="card shadow-sm  border-primary" style="margin-top: 11px;">
                            <div class="card-header py-3 text-white bg-primary">
                                <h4 class="my-0 fw-normal" style="text-align:center">Create actuator</h4>
                            </div>
                            <div class="card-body">
                                <div class="container">
                                    <div class="row">
                                      <div class="col">
                                        Actuator Type:
                                      </div>
                                      <div class="col">
                                        <select name="new_actuator_type" id="new_actuator_type" class="form-control">
                                            {% for actuator_type in all_actuators %}
                                            <option value="{{ actuator_type.actuator_name() }}">{{ actuator_type.actuator_name() }}</option>
                                            {% endfor %}
                                        </select>
                                      </div>
                                    </div>
                                    <div class="row" style="margin-top: 20px;">
                                      <div class="col">
                                        Pin:
                                      </div>
                                      <div class="col">
                                        <select name="new_actuator_pin" id="new_actuator_pin" class="form-control">
                                            {% for pin in pins %}
                                            <option value="{{ pin }}">{{ pin }}</option>
                                            {% endfor %}
                                        </select>
                                      </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="button" id="add_new_actuator_button" class="w-100 btn btn-lg btn-primary" >Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-9">
                        <div class="container">
                            <div class="row row-cols-1 row-cols-sm-2 row-cols-sm-3 g-3">
                                
                                {% for actuator in actuators %}

                                <div class="col">
                                    {% if actuator.actuator_name() == "LED": %}
                                        {% with actuator=actuator %}
                                            {% include "led_actuator.html" %}
                                        {% endwith %}
                                    {% endif %}
                                </div>

                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener("DOMContentLoaded", function () {
            var add_new_sensor_button = document.getElementById("add_new_sensor_button")
            var add_new_actuator_button = document.getElementById("add_new_actuator_button")
            var new_sensor_type_control = document.getElementById("new_sensor_type")
            var new_actuator_type_control = document.getElementById("new_actuator_type")
            var new_sensor_pin_control = document.getElementById("new_sensor_pin")
            var new_actuator_pin_control = document.getElementById("new_actuator_pin")
            var new_sensor_units_control = document.getElementById("new_sensor_units")

            add_new_sensor_button.addEventListener("click", function () {
                var new_sensor_type = new_sensor_type_control.value
                var new_sensor_unit = new_sensor_units_control.value
                var new_sensor_pin = parseInt(new_sensor_pin_control.value)

                var payload = {
                    'type': new_sensor_type,
                    'pin': new_sensor_pin,
                    'unit': new_sensor_unit
                }

                var xhr = new XMLHttpRequest();
                var url = "./create_sensor";
                xhr.open("POST", url, false);
                xhr.setRequestHeader("Content-Type", "application/json");
                var data = JSON.stringify(payload);
                xhr.send(data);
                location.reload();
            });

            add_new_actuator_button.addEventListener("click", function () {
                var new_actuator_type = new_actuator_type_control.value
                var new_actuator_pin = parseInt(new_actuator_pin_control.value)

                var payload = {
                    'type': new_actuator_type,
                    'pin': new_actuator_pin
                }

                var xhr = new XMLHttpRequest();
                var url = "./create_actuator";
                xhr.open("POST", url, false);
                xhr.setRequestHeader("Content-Type", "application/json");
                var data = JSON.stringify(payload);
                xhr.send(data);
                location.reload();
            });

            function populate_units() {
                var new_sensor_type = new_sensor_type_control.value

                var payload = {
                    'type': new_sensor_type,
                }

                var xhr = new XMLHttpRequest();
                var url = "./sensor_units";

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        response = JSON.parse(xhr.response)
                        var inner = ""
                        response.units.forEach(function (item, index) {
                            inner += "<option value=\"" + item + "\">" + item + "</option>"
                        });

                        new_sensor_units_control.innerHTML = inner
                    }
                }

                xhr.open("POST", url, false);
                xhr.setRequestHeader("Content-Type", "application/json");
                var data = JSON.stringify(payload);
                xhr.send(data);
            }

            new_sensor_type_control.addEventListener('change', (event) => {
                populate_units()
            });

            populate_units()
        })
    </script>

</body>

</html>